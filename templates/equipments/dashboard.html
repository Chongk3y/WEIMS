{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% load static %}

{% block content %}
<style>
  /* Uniform chart card and canvas sizing */
  .dashboard-chart-card .card-body {
    min-height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .dashboard-chart-card canvas {
    width: 100% !important;
    height: 180px !important;
    max-width: 100%;
    max-height: 180px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid py-3 px-3">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-semibold mb-0">Dashboard</h4>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center">
        <div class="card-body p-2">
          <small class="text-muted">Total</small>
          <h5 class="fw-bold">{{ total_equipments }}</h5>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center">
        <div class="card-body p-2">
          <small class="text-muted">Archived</small>
          <h5 class="fw-bold text-danger">{{ total_archived }}</h5>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center">
        <div class="card-body p-2">
          <small class="text-muted">Returned</small>
          <h5 class="fw-bold text-success">{{ total_returned }}</h5>
        </div>
      </div>
    </div>
    {% for status in status_counts %}
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 text-center">
        <div class="card-body p-2">
          <small class="text-muted">{{ status.name }}</small>
          <h6 class="fw-bold text-dark">{{ status.count }}</h6>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Charts and Recent -->
  <div class="row mt-4 g-3">
    <!-- Recent -->
    <div class="col-md-4">
      <div class="card shadow-sm border-0">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ•’ Recent Equipments</small>
        </div>
        <div class="card-body p-2">
          {% if recent_equipments %}
          <ul class="list-group list-group-flush small">
            {% for eq in recent_equipments %}
            <li class="list-group-item d-flex justify-content-between align-items-start px-2 py-1">
              <div>
                <strong>{{ eq.item_name }}</strong><br>
                <small class="text-muted">{{ eq.item_propertynum }} â€¢ {{ eq.item_purdate }}</small>
              </div>
              <span class="badge bg-secondary">{{ eq.category.name }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted small">No recent items.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Category Bar Chart -->
    <div class="col-md-4">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ“‚ By Category</small>
        </div>
        <div class="card-body p-2">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Status Pie Chart -->
    <div class="col-md-4">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ“Š By Status</small>
        </div>
        <div class="card-body p-2">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Monthly Line Chart -->
  <div class="row mt-4 g-3">
    <div class="col-md-12">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ“ˆ Equipments Acquired Per Year (PO Date)</small>
        </div>
        <div class="card-body p-2">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Equipments by End User: Count and Total Cost -->
  <div class="row mt-4 g-3">
    <div class="col-md-12">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ‘¤ Equipments by End User: Count & Total Cost</small>
        </div>
        <div class="card-body p-2">
          <canvas id="endUserChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Equipments by Assigned To: Count and Total Cost -->
  <div class="row mt-4 g-3">
    <div class="col-md-12">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ‘¤ Equipments by Assigned To: Count & Total Cost</small>
        </div>
        <div class="card-body p-2">
          <canvas id="assignedToChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Equipments by Item Name: Total Number -->
  <div class="row mt-4 g-3">
    <div class="col-md-12">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header py-2 bg-light">
          <small class="fw-semibold">ðŸ”¢ Equipments by Name: Total Number</small>
        </div>
        <div class="card-body p-2">
          <canvas id="itemNameChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart Scripts -->
<script>
  // Category Bar Chart
  const ctxCategory = document.getElementById('categoryChart').getContext('2d');
  new Chart(ctxCategory, {
    type: 'bar',
    data: {
      labels: {{ category_labels|safe }},
      datasets: [{
        label: 'Equipments',
        data: {{ category_counts|safe }},
        backgroundColor: '#0e4a39',
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // Status Pie Chart
  const ctxStatus = document.getElementById('statusChart').getContext('2d');
  new Chart(ctxStatus, {
    type: 'pie',
    data: {
      labels: {{ status_labels|safe }},
      datasets: [{
        label: 'By Status',
        data: {{ status_data|safe }},
        backgroundColor: [
          '#0e4a39', '#198754', '#ffc107', '#dc3545', '#6c757d', '#0d6efd', '#6610f2', '#fd7e14', '#20c997', '#e83e8c'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });

  // Monthly Line Chart
  const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
  new Chart(ctxMonthly, {
    type: 'line',
    data: {
      labels: {{ month_labels|safe }},
      datasets: [{
        label: 'Added',
        data: {{ month_data|safe }},
        fill: false,
        borderColor: '#0e4a39',
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // Equipments by End User: Count and Total Cost (Grouped Bar)
  const ctxEndUser = document.getElementById('endUserChart').getContext('2d');
  new Chart(ctxEndUser, {
    type: 'bar',
    data: {
      labels: {{ enduser_labels|safe }},
      datasets: [
        {
          label: 'Number of Equipments',
          data: {{ enduser_counts|safe }},
          backgroundColor: '#0d6efd',
          yAxisID: 'y',
        },
        {
          label: 'Total Cost',
          data: {{ enduser_amounts|safe }},
          backgroundColor: '#ffc107',
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Total Cost (â‚±)' },
        }
      }
    }
  });

  // Equipments by Assigned To: Count and Total Cost (Grouped Bar)
  const ctxAssignedTo = document.getElementById('assignedToChart').getContext('2d');
  new Chart(ctxAssignedTo, {
    type: 'bar',
    data: {
      labels: {{ assigned_labels|safe }},
      datasets: [
        {
          label: 'Number of Equipments',
          data: {{ assigned_counts|safe }},
          backgroundColor: '#20c997',
          yAxisID: 'y',
        },
        {
          label: 'Total Cost',
          data: {{ assigned_amounts|safe }},
          backgroundColor: '#fd7e14',
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Total Cost (â‚±)' },
        }
      }
    }
  });

  // Equipments by Item Name: Total Number (Bar)
  const ctxItemName = document.getElementById('itemNameChart').getContext('2d');
  new Chart(ctxItemName, {
    type: 'bar',
    data: {
      labels: {{ itemname_labels|safe }},
      datasets: [{
        label: 'Total Number',
        data: {{ itemname_counts|safe }},
        backgroundColor: '#6610f2',
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });
</script>
{% endblock %}
