{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% load static %}

{% block content %}
<style>
  .dashboard-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }
  .card-metric {
    color: #fff;
    text-align: center;
    padding: 1rem;
  }
  .dashboard-chart-card .card-body {
    padding: 1rem;
    height: 260px;
  }
  .dashboard-chart-card canvas {
    width: 100% !important;
    height: 100% !important;
  }
  .card-header-sm {
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.6rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }
  .card-header-dark {
    background-color: #0d6efd;
    color: #fff;
    padding: 0.75rem 1rem;
    font-weight: 600;
  }
  .view-all-link {
    display: block;
    text-align: center;
    margin-top: 0.75rem;
    font-size: 0.85rem;
    font-weight: 500;
    text-decoration: none;
    color: #0d6efd;
  }
  .view-all-link:hover {
    text-decoration: underline;
  }
</style>

<div class="container-fluid py-4 px-3">
  <!-- Header -->
  <div class="dashboard-header">
    <h4 class="fw-semibold mb-0">ðŸ“Š Dashboard Overview</h4>
    <a href="{% url 'equipments:add' %}" class="btn btn-outline-success btn-sm">
      <i class="bi bi-plus-circle"></i> Add Equipment
    </a>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3">
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 bg-primary">
        <div class="card-metric">
          <h2 class="fw-bold">{{ total_equipments }}</h2>
          <small>Total Equipments</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 bg-info">
        <div class="card-metric">
          <h2 class="fw-bold">{{ total_archived }}</h2>
          <small>Archived</small>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 bg-success">
        <div class="card-metric">
          <h2 class="fw-bold">{{ total_returned }}</h2>
          <small>Returned</small>
        </div>
      </div>
    </div>
    {% for status in status_counts %}
    <div class="col-6 col-md-3">
      <div class="card shadow-sm border-0 bg-warning">
        <div class="card-metric">
          <h2 class="fw-bold">{{ status.count }}</h2>
          <small>{{ status.name }}</small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Recent / Category / Status -->
  <div class="row mt-4 g-3">
    <div class="col-md-4 d-flex">
      <div class="card shadow-sm border-0 flex-fill d-flex flex-column">
        <div class="card-header-dark">
          <i class="bi bi-clock-history me-1"></i> Recent Equipments
        </div>
        <div class="card-body p-3 flex-grow-1">
          {% if recent_equipments %}
          <ul class="list-group list-group-flush">
            {% for eq in recent_equipments %}
            <li class="list-group-item d-flex justify-content-between align-items-start px-3 py-2">
              <div>
                <div class="fw-semibold">{{ eq.item_name }}</div>
                <div class="text-muted small">{{ eq.item_propertynum }} â€¢ {{ eq.item_purdate }}</div>
              </div>
              <span class="badge bg-info text-white">{{ eq.category.name }}</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-center text-muted">No recent equipments.</div>
          {% endif %}
        </div>
        <div class="mt-auto px-3 pb-3">
          <a href="{% url 'equipments:index' %}" class="view-all-link">View All</a>
        </div>
      </div>
    </div>

    <div class="col-md-4 d-flex">
      <div class="card shadow-sm border-0 dashboard-chart-card flex-fill">
        <div class="card-header-dark">
          <i class="bi bi-folder2-open me-1"></i> By Category
        </div>
        <div class="card-body"><canvas id="categoryChart"></canvas></div>
      </div>
    </div>

    <div class="col-md-4 d-flex">
      <div class="card shadow-sm border-0 dashboard-chart-card flex-fill">
        <div class="card-header-dark">
          <i class="bi bi-pie-chart-fill me-1"></i> By Status
        </div>
        <div class="card-body"><canvas id="statusChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Acquired Per Month -->
  <div class="row mt-4 g-3">
    <div class="col-md-12">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header-sm d-flex justify-content-between align-items-center">
          ðŸ“… Equipments Acquired Per Year
          <form method="get" id="yearFilterForm">
            <select name="year" id="yearDropdown" class="form-select form-select-sm" style="width: auto;"
              onchange="document.getElementById('yearFilterForm').submit();">
              {% for y in available_years %}
              <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
        <div class="card-body" style="height: 280px;">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- End User & Assigned To -->
  <div class="row mt-4 g-3">
    <div class="col-md-6">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header-sm">ðŸ‘¤ Equipments by End User: Count & Total Cost</div>
        <div class="card-body"><canvas id="endUserChart"></canvas></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm border-0 dashboard-chart-card">
        <div class="card-header-sm">ðŸ‘¤ Equipments by Assigned To: Count & Total Cost</div>
        <div class="card-body"><canvas id="assignedToChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Item Names -->
  <div class="row mt-4 g-3">
    <div class="col-md-12">
      <div class="card shadow-sm border-0 dashboard-chart-card" style="max-height: 1000px;">
        <div class="card-header-sm">ðŸ”¢ Equipments by Name: Total Number & Amount</div>
        <div class="card-body" style="overflow-y: auto; height: 800px;">

          <canvas id="itemNameChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Viewing Equipments by End User -->
<div class="modal fade" id="userEquipmentsModal" tabindex="-1" aria-labelledby="userEquipmentsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userEquipmentsLabel">
          Equipments Assigned to <span id="modalUserName"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
        <ul class="list-group" id="userEquipmentsList"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const renderBarChart = (id, labels, data, label, color) => {
    new Chart(document.getElementById(id), {
      type: 'bar',
      data: { labels, datasets: [{ label, data, backgroundColor: color, borderRadius: 5 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, title: { display: true, text: 'Count' } } }
      }
    });
  };

  const renderPieChart = (id, labels, data) => {
    new Chart(document.getElementById(id), {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: ['#0d6efd','#20c997','#ffc107','#dc3545','#6f42c1','#6610f2','#fd7e14','#0dcaf0']
        }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
  };

  const renderLineChart = (id, labels, data) => {
    new Chart(document.getElementById(id), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Added',
          data,
          fill: true,
          borderColor: '#0e4a39',
          backgroundColor: 'rgba(14,74,57,0.1)',
          pointRadius: 4,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Count' } },
          x: { title: { display: true, text: 'Year' } }
        }
      }
    });
  };

  const renderHorizontalBarWithTooltip = (id, labels, data, amounts) => {
    const canvas = document.getElementById(id);
    canvas.height = labels.length * 25;
    new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: 'Count', data, backgroundColor: '#6610f2', borderRadius: 4 }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const i = ctx.dataIndex;
                return `Count: ${data[i]}, Amount: â‚±${(amounts[i]||0).toLocaleString()}`;
              }
            }
          },
          legend: { display: false }
        },
        scales: {
          x: { beginAtZero: true, title: { display: true, text: 'Count' } },
          y: { title: { display: true, text: 'Item Name' } }
        }
      }
    });
  };

  renderBarChart('categoryChart', {{ category_labels|safe }}, {{ category_counts|safe }}, 'Equipments', '#0e4a39');
  renderPieChart('statusChart', {{ status_labels|safe }}, {{ status_data|safe }});
  renderLineChart('monthlyChart', {{ month_labels|safe }}, {{ month_data|safe }});
  renderHorizontalBarWithTooltip('itemNameChart', {{ itemname_labels|safe }}, {{ itemname_counts|safe }}, {{ itemname_amounts|safe }});

  new Chart(document.getElementById('assignedToChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: {{ assigned_labels|safe }},
      datasets: [
        { label: 'Count', data: {{ assigned_counts|safe }}, backgroundColor: '#0d6efd', yAxisID: 'y' },
        { label: 'Total Cost', data: {{ assigned_amounts|safe }}, backgroundColor: '#ffc107', yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Count' } },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Total Cost (â‚±)' }
        }
      }
    }
  });

  // Interactive End User chart
  new Chart(document.getElementById('endUserChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: {{ enduser_labels|safe }},
      datasets: [
        { label: 'Count', data: {{ enduser_counts|safe }}, backgroundColor: '#0d6efd', yAxisID: 'y' },
        { label: 'Total Cost', data: {{ enduser_amounts|safe }}, backgroundColor: '#ffc107', yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Count' } },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Total Cost (â‚±)' }
        }
      },
      onClick: async function (evt, elements) {
        if (!elements.length) return;
        const idx = elements[0].index;
        const user = this.data.labels[idx];
        document.getElementById('modalUserName').innerText = user;
        const resp = await fetch(`/equipments/by-user/?username=${encodeURIComponent(user)}`);
        const items = await resp.json();
        const list = document.getElementById('userEquipmentsList');
        list.innerHTML = '';

        if (items.length) {
          items.forEach(eq => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = `<strong>${eq.name}</strong> <small class="text-muted">(${eq.category})</small>`;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = `<li class="list-group-item text-muted">No equipments found.</li>`;
        }

        new bootstrap.Modal(document.getElementById('userEquipmentsModal')).show();
      }
    }
  });
</script>
{% endblock %}
