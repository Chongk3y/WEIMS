{% extends 'base.html' %}
{% load humanize %}
{% block title %}Equipment List{% endblock %}
{% block content %}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="container-fluid py-2 px-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-semibold mb-0">ðŸ“‹ Equipment Management</h5>
  </div>

  <!-- Combined Toolbar Row -->
  <div class="row gx-2 gy-1 align-items-center ">

    <!-- Search Bar -->
    <div class="col-md-3">
      <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search equipment...">
    </div>

      <!-- Status Dropdown -->
      <div class="col-md-2">
        <select name="status_id" form="bulkUpdateForm" class="form-select form-select-sm">
          <option value="">Change Status...</option>
          {% for status in statuses %}
            <option value="{{ status.id }}">{{ status.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Category Dropdown -->
      <div class="col-md-2">
        <select name="category_id" form="bulkUpdateForm" class="form-select form-select-sm">
          <option value="">Change Category...</option>
          {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Apply to Selected Button -->
      <div class="col-md-2">
        <form id="bulkUpdateForm" method="post" action="{% url 'equipments:bulk_update' %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-primary btn-sm w-100">Apply to Selected</button>
        </form>
      </div>

      <!-- Advanced Filter Button -->
      <div class="col-md-auto">
        <button type="button" class="btn btn-outline-dark btn-sm w-100" data-bs-toggle="modal" data-bs-target="#advancedFilterModal">
          <i class="bi bi-funnel"></i> Filter
        </button>
      </div>

      {% if is_admin or is_encoder %}
      <!-- Import Excel Button -->
      <div class="col-md-auto">
        <form action="{% url 'equipments:import_excel' %}" method="post" enctype="multipart/form-data" id="importExcelForm">
          {% csrf_token %}
          <input type="file" name="excel_file" accept=".xlsx,.xls" style="display:none;" id="importExcelInput" onchange="this.form.submit()">
          <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="document.getElementById('importExcelInput').click();">
            <i class="bi bi-upload"></i> Import
          </button>
        </form>
      </div>

      <!-- Print Button -->
      <div class="col-md-auto">
        <button type="button" onclick="window.print()" class="btn btn-outline-secondary btn-sm w-100">
          <i class="bi bi-printer"></i>
        </button>
      </div>

      <!-- Add Equipment Button -->
      <div class="col-md-auto">
        <a href="{% url 'equipments:add' %}" class="btn btn-outline-success btn-sm w-100">
          <i class="bi bi-plus-circle small"></i> Add
        </a>
      </div>
      {% endif %}
    </div>

    <div class="dropdown mb-2">
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="columnVisibilityDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        Columns
      </button>
      <ul class="dropdown-menu" aria-labelledby="columnVisibilityDropdown" id="columnVisibilityMenu">
        <!-- JS will populate this -->
      </ul>
    </div>
  </div>


  <!-- Equipment Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-2">
      <div class="table-responsive">
        <table id="equipmentTable" class="table ...">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th style="display:none;"></th> <!-- Hidden ID column -->
              <th>Image</th>
              <th>Property #</th>
              <th>Name</th>
              <th>Description</th>
              <th>PO Number</th>
              <th>Amount</th>
              <th>End User</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Place this at the end of your file, outside any <table> or <form> -->
<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="returnForm" method="post" enctype="multipart/form-data" action="{% url 'equipments:return_equipment' %}">
      {% csrf_token %}
      <input type="hidden" name="equipment_id" id="returnEquipmentId">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="returnModalLabel">Return Equipment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="returnDocument" class="form-label">Upload Return Document</label>
            <input type="file" class="form-control" id="returnDocument" name="return_document" accept=".pdf,image/*" required>
          </div>
          <div class="mb-3">
            <label for="returnRemarks" class="form-label">Remarks</label>
            <textarea class="form-control" id="returnRemarks" name="return_remarks" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label for="returnCondition" class="form-label">Condition Upon Return</label>
            <select class="form-select" id="returnCondition" name="return_condition">
              <option value="">Select condition</option>
              <option value="Good">Good</option>
              <option value="Needs Repair">Needs Repair</option>
              <option value="Damaged">Damaged</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="returnType" class="form-label">Return Type</label>
            <select class="form-select" id="returnType" name="return_type">
              <option value="">Select type</option>
              <option value="Return">Return</option>
              <option value="Retirement">Retirement</option>
              <option value="Disposal">Disposal</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit Return</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Equipment Details Modal -->
<div class="modal fade" id="equipmentModal" tabindex="-1" aria-labelledby="equipmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-1">
        <h5 class="modal-title fw-semibold" id="equipmentModalLabel">ðŸ“„ Equipment Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-1 px-3" style="max-height: 75vh; overflow-y: auto;">
        <div class="row mb-3">
          <div class="col-md-4 text-center">
            <img id="modalImage" src="" class="img-fluid rounded shadow-sm" style="width: 120px; height: 120px; object-fit: cover;" alt="Equipment Image">
          </div>
          <div class="col-md-8">
            <div class="row g-2">
              <div class="col-sm-6"><small class="text-muted">Property #</small><div id="modalPropertyNum" class="fw-medium"></div></div>
              <div class="col-sm-6"><small class="text-muted">Name</small><div id="modalName" class="fw-medium"></div></div>
              <div class="col-sm-12"><small class="text-muted">Description</small><div id="modalDesc" class="fw-normal text-wrap"></div></div>
              <div class="col-sm-12"><small class="text-muted">Additional Info</small><div id="modalAddInfo" class="text-muted"></div></div>
              <div class="col-sm-6"><small class="text-muted">Amount</small><div id="modalAmount" class="fw-medium text-success"></div></div>
              <div class="col-sm-6"><small class="text-muted">Category</small><div id="modalCategory"></div></div>
              <div class="col-sm-6"><small class="text-muted">Status</small><div id="modalStatus"></div></div>
              <div class="col-sm-6"><small class="text-muted">PO Number</small><div id="modalPONumber"></div></div>
              <div class="col-sm-6"><small class="text-muted">PO Date</small><div id="modalPODate"></div></div>
              <div class="col-sm-6"><small class="text-muted">Fund Source</small><div id="modalFundSource"></div></div>
              <div class="col-sm-6"><small class="text-muted">Supplier</small><div id="modalSupplier"></div></div>
              <div class="col-sm-6"><small class="text-muted">Project Name</small><div id="modalProjectName"></div></div>
              <div class="col-sm-6"><small class="text-muted">Assigned To</small><div id="modalAssignedTo"></div></div>
              <div class="col-sm-6"><small class="text-muted">End User</small><div id="modalEndUser"></div></div>
              <div class="col-sm-6"><small class="text-muted">Deployment Location</small><div id="modalLocation"></div></div>
              <div class="col-sm-6"><small class="text-muted">Current Location</small><div id="modalCurrentLocation"></div></div>
              <div class="col-sm-6"><small class="text-muted">Created</small><div id="modalCreated"></div></div>
              <div class="col-sm-6"><small class="text-muted">Created By</small><div id="modalCreatedBy"></div></div>
              <div class="col-sm-6"><small class="text-muted">Updated</small><div id="modalUpdated"></div></div>
              <div class="col-sm-6"><small class="text-muted">Updated By</small><div id="modalUpdatedBy"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="advancedFilterModal" tabindex="-1" aria-labelledby="advancedFilterLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="advancedFilterLabel">Advanced Filter</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="filterForm">
          <div id="filterContainer"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="addFilterRow">+ Add Filter</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" id="applyFilter" class="btn btn-primary btn-sm">Apply Filters</button>
      </div>
    </div>
  </div>
</div>




<!-- Compact Table Style -->
<style>
  .compact-table td, .compact-table th {
    white-space: nowrap;          /* Prevents breaking mid-word */
    overflow: hidden;
    text-overflow: ellipsis;      /* Shows "..." if too long */
    max-width: 160px;

  }
    /* Allow wrapping for selected columns */
  .compact-table td.text-wrap,
  .compact-table th.text-wrap {
    white-space: normal;
    word-break: break-word;
  }

  #tableSearch {
    min-width: 250px;
    max-width: 400px;
    padding-left: 1.5rem;
    border: 1px solid #ced4da;
    transition: box-shadow 0.2s ease-in-out;
    font-size: 0.8rem;
  }

  #tableSearch:focus {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    border-color: #80bdff;
  }

  select.form-select-sm, .btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
    /* Make pagination text and buttons smaller */
  .dataTables_paginate .pagination {
    font-size: 0.75rem;       /* Smaller text */
    gap: 0.25rem;              /* Less spacing between buttons */
  }

  .dataTables_paginate .page-link {
    padding: 0.25rem 0.5rem;   /* Smaller button padding */
    font-size: 0.75rem;        /* Smaller font size inside buttons */
  }

  .dataTables_wrapper .dataTables_paginate {
    margin-top: 0.5rem;
  }

    #equipmentModal .modal-body div {
    font-size: 0.88rem;
  }
  #equipmentModal .fw-medium {
    font-weight: 500;
  }

    @media (max-width: 768px) {
  .table-responsive {
    overflow-x: auto;
  }

  .compact-table td, .compact-table th {
    font-size: 0.75rem;
    padding: 0.25rem 0.4rem;
  }
}
</style>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
let table;
$(document).ready(function () {

  const columnMap = {
  2: 'Property #',
  3: 'Name',
  4: 'Description',
  5: 'Amount',
  6: 'Category',
  7: 'Status'
};

  // Init DataTable
table = $('#equipmentTable').DataTable({
  dom: 'lrtip',
  serverSide: true,
  processing: true,
  // stateSave: true,
  ajax: {
    url: '/equipments/equipment/table/json/',
    type: 'GET',
    data: function (d) {
      // Gather all filters
      $('.filter-row').each(function () {
        const colIdx = $(this).find('.column-select').val();
        const value = $(this).find('.value-input').val();
        d['filter_col_' + colIdx] = value;
      });
    }
  },
  columns: [
    {
      data: null,
      orderable: false,
      render: function (data, type, row) {
        return `<input type="checkbox" class="equipment-checkbox" value="${row[1]}">`; // row[1] is the ID now
      }
    },
    { visible: false }, // 1: ID (hidden)
    { title: "Image", orderable: false }, // 2
    { title: "Property #" },              // 3
    { title: "Name" },                    // 4
    { title: "Description" },             // 5
    { title: "PO Number" },               // 
    { title: "Amount" },                  // 6
    { title: "End User" },                //
    { title: "Category" },                // 7
    { title: "Status" },                  // 8
    { title: "Actions", orderable: false } // 9
  ],
  pageLength: 10
});

// Column titles in order (match your DataTable columns)
const columnTitles = [
  "Select",      // 0
  "ID",          // 1 (hidden)
  "Image",       // 2
  "Property #",  // 3
  "Name",        // 4
  "Description", // 5
  "PO Number",   // 6 
  "Amount",      // 7
  "End User",    // 8
  "Category",    // 9
  "Status",      // 10
  "Actions"      // 11
];

// Default visible columns (true = visible, false = hidden)
const defaultVisible = [
  true,  // 0: 
  false, // 1: 
  true,  // 2: 
  true,  // 3: 
  true,  // 4: 
  true,  // 5: 
  true,  // 6: 
  true,  // 7: 
  true,  // 8: 
  true,  // 9: 
  true,  // 10: 
  true   // 11: 
];

// Populate the dropdown
columnTitles.forEach((title, idx) => {
  // Don't show the "ID" column in the menu
  if (title === "ID") return;

    $('#columnVisibilityMenu').append(`
      <li>
        <label class="dropdown-item">
          <input type="checkbox" class="toggle-vis" data-column="${idx}" ${defaultVisible[idx] ? 'checked' : ''}>
          ${title}
        </label>
      </li>
    `);
  });

  $('#columnVisibilityMenu').on('click', function (e) {
    e.stopPropagation();
  });

    // Handle toggling
  $('#columnVisibilityMenu').on('change', '.toggle-vis', function () {
    var column = table.column($(this).data('column'));
    column.visible(this.checked, false); // false = don't redraw yet
    table.columns.adjust().draw(false);  // redraw after all changes
  });



  // Custom global search
  $('#tableSearch').on('keyup', function () {
    table.search(this.value).draw();
  });

  // Add filter row
  $('#addFilterRow').click(function () {
    const idx = $('.filter-row').length;
    const selectOptions = Object.entries(columnMap).map(
      ([i, name]) => `<option value="${i}">${name}</option>`
    ).join('');

    $('#filterContainer').append(`
      <div class="row mb-2 filter-row" data-idx="${idx}">
        <div class="col-md-5">
          <select class="form-select form-select-sm column-select">${selectOptions}</select>
        </div>
        <div class="col-md-5 value-col">
          <input type="text" class="form-control form-control-sm value-input" placeholder="Enter value">
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger remove-filter">&times;</button>
        </div>
      </div>
    `);
  });

    $(document).on('change', '.column-select', function () {
    const colIdx = $(this).val();
    const $valueCol = $(this).closest('.filter-row').find('.value-col');
    if (colIdx == '6') {
      // Category
      $valueCol.html(`<select class="form-select form-select-sm value-input">
        <option value="">All</option>
        {% for cat in categories %}
          <option value="{{ cat.name }}">{{ cat.name }}</option>
        {% endfor %}
      </select>`);
    } else if (colIdx == '7') {
      // Status
      $valueCol.html(`<select class="form-select form-select-sm value-input">
        <option value="">All</option>
        {% for stat in statuses %}
          <option value="{{ stat.name }}">{{ stat.name }}</option>
        {% endfor %}
      </select>`);
    } else {
      // Default to text input
      $valueCol.html('<input type="text" class="form-control form-control-sm value-input" placeholder="Enter value">');
    }
  });
  // Remove filter row
  $(document).on('click', '.remove-filter', function () {
    $(this).closest('.filter-row').remove();
  });

  // Apply filters
  $('#applyFilter').click(function () {
    // 1. Gather filtered column indices
    let filteredCols = [];
    $('.filter-row').each(function () {
      const colIdx = parseInt($(this).find('.column-select').val());
      if (!isNaN(colIdx)) filteredCols.push(colIdx);
    });

    // 4. Reload data
    table.ajax.reload();
    $('#advancedFilterModal').modal('hide');
  });

  $('#equipmentTable tbody').on('click', 'tr', function (e) {
  
    if (
      $(e.target).closest('button').length ||
      $(e.target).closest('a').length ||
      $(e.target).closest('td').index() === 9 // Actions column index (adjust if needed)
    ) {
      return;
    }

    var table = $('#equipmentTable').DataTable();
    var data = table.row(this).data();
    var equipmentId = data[1]; // This is the hidden ID column, always present in the data array

    // Now fetch and show the modal as before
    $.get(`/equipments/equipment/${equipmentId}/json/`, function(data) {
        $('#modalImage').attr('src', data.image);
        $('#modalPropertyNum').text(data.propertynum);
        $('#modalName').text(data.name);
        $('#modalDesc').text(data.desc);
        $('#modalAddInfo').text(data.addinfo);
        $('#modalAmount').text('â‚±' + data.amount);
        $('#modalCategory').text(data.category);
        $('#modalStatus').text(data.status);
        $('#modalPONumber').text(data.po_number);
        $('#modalPODate').text(data.po_date);
        $('#modalFundSource').text(data.fund_source);
        $('#modalSupplier').text(data.supplier);
        $('#modalProjectName').text(data.project_name);
        $('#modalAssignedTo').text(data.assigned_to);
        $('#modalEndUser').text(data.end_user);
        $('#modalLocation').text(data.location);
        $('#modalCurrentLocation').text(data.current_location);
        $('#modalCreated').text(data.created);
        $('#modalCreatedBy').text(data.created_by);
        $('#modalUpdated').text(data.updated);
        $('#modalUpdatedBy').text(data.updated_by);
        $('#equipmentModal').modal('show');
      });
  });

  $('#selectAll').on('click', function () {
    $('.equipment-checkbox').prop('checked', this.checked);
  });
  
  $('#bulkUpdateForm').on('submit', function (e) {
    e.preventDefault();
    const selectedIds = $('.equipment-checkbox:checked')
      .map((_, cb) => cb.value)
      .get();

    if (selectedIds.length === 0) {
      alert("Please select at least one equipment.");
      return;
    }

    const formData = $(this).serializeArray();
    formData.push({ name: 'equipment_ids', value: selectedIds.join(',') });

    $.post($(this).attr('action'), formData, function (response) {
      alert("Bulk update successful.");
      table.ajax.reload(); // Refresh table
    }).fail(function () {
      alert("Something went wrong.");
    });
  });
  

  $('#returnModal').on('show.bs.modal', function (event) {
    $('.modal').not(this).modal('hide');
    var button = $(event.relatedTarget);
    var eqId = button.data('eqid');
    $('#returnEquipmentId').val(eqId);
  });
  
  
});
</script>
{% endblock %}
