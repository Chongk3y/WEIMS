{% extends 'base.html' %}
{% load humanize %}
{% block title %}Equipment List{% endblock %}
{% block content %}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}
{% endif %}
<div class="container-fluid py-2 px-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="fw-semibold mb-0">ðŸ“‹ Equipment Management</h5> 
  </div>

  <!-- Filters -->
  <form method="get" class="row gx-2 gy-2 align-items-center mb-3">
    <div class="col-md-3">
      <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="Search...">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All Statuses</option>
        {% for stat in statuses %}
        <option value="{{ stat.id }}" {% if request.GET.status == stat.id|stringformat:"s" %}selected{% endif %}>{{ stat.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="col-auto">
      <input type="hidden" name="order" value="{% if request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">
      <button type="submit" class="btn btn-outline-secondary btn-sm" title="Toggle Order">
        <i class="bi {% if request.GET.order == 'asc' %}bi-sort-down-alt{% else %}bi-sort-up{% endif %} small"></i>
      </button>
    </div>

    {% if is_admin or is_encoder %}
    <div class="col-auto">
      <button type="button" onclick="window.print()" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-printer"></i>
      </button>
    </div>
    <div class="col-auto">
      <a href="{% url 'equipments:add' %}" class="btn btn-outline-success btn-sm">
        <i class="bi bi-plus-circle small"></i> Add
      </a>
    </div>
    {% endif %}
  </form>

    <form action="{% url 'equipments:import_excel' %}" method="post" enctype="multipart/form-data" class="d-inline">
      {% csrf_token %}
      <input type="file" name="excel_file" accept=".xlsx,.xls" style="display:none;" id="importExcelInput" onchange="this.form.submit()">
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('importExcelInput').click();">
        <i class="bi bi-upload"></i> Import Excel
      </button>
    </form>

  <!-- Equipment Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-2">
      <div class="table-responsive">
        <table id="equipmentTable" class="table table-sm table-hover table-bordered align-middle text-nowrap compact-table">
          <thead class="table-light text-center">
            <tr>
              <!-- Procurement Details -->
              <th>Image</th>
              <th>Property #</th>
              <th>Name</th>
              <th class="d-none d-md-table-cell">Description</th>
              <th class="d-none d-md-table-cell">Additional Info</th>

              <!-- Procurement Details -->
              <th>PO Number</th>
              <th>Fund Source</th>
              <th>Supplier</th>
              <th>Amount</th>
              <th>PO Date</th>

              <!-- Assignment -->
              <th>Project Name</th>
              <th>Assigned To</th>
              <th>End User</th>

              <!-- Location Context -->
              <th>Deployment Location</th>
              <th>Current Location</th>

              <!-- Classification -->
              <th>Category</th>
              <th>Status</th>

              <!-- Timestamps -->
              <th>Created</th>
              <th>Created By</th>
              <th>Updated</th>
              <th>Updated By</th>

              <!-- Action Buttons -->
              <th>Actions</th>
              
            </tr>
          </thead>
          <tbody style="font-size: 0.8rem;">
            {% for equipment in equipments %}
            <tr>
              <!-- Procurement Details -->
              <td class="text-center">
                {% if equipment.user_image %}
                  <img src="{{ equipment.user_image.url }}" class="img-thumbnail" style="width: 32px; height: 32px; object-fit: cover; padding: 1px;">
                {% else %}
                  <span class="text-muted small">No Image</span>
                {% endif %}
              </td>
              <td>{{ equipment.item_propertynum }}</td>
              <td>{{ equipment.item_name }}</td>
              <td class="d-none d-md-table-cell">{{ equipment.item_desc }}</td>
              <td class="d-none d-md-table-cell">{{ equipment.additional_info }}</td>


              <td>{{ equipment.po_number }}</td>
              <td>{{ equipment.fund_source }}</td>
              <td>{{ equipment.supplier }}</td>
              <td class="text-start">â‚±{{ equipment.item_amount|floatformat:2|intcomma }}</td>
              <td>{{ equipment.item_purdate|date:"M d, Y" }}</td>

              <!-- Assignment -->
              <td>{{ equipment.project_name }}</td>
              <td>{{ equipment.assigned_to }}</td>
              <td>{{ equipment.end_user }}</td>


              <!-- Location Context -->
              <td>{{ equipment.location }}</td>
              <td>{{ equipment.current_location }}</td>

              <!-- Classification -->
              <td>{{ equipment.category.name }}</td>
              <td>
                <span class="badge bg-info text-dark small">{{ equipment.status.name }}</span>
              </td>

              <!-- Timestamps -->
              <td>{{ equipment.created_at|date:"M d, Y" }}</td>
              <td>
                {% if equipment.created_by %}
                  {{ equipment.created_by.first_name }} {{ equipment.created_by.last_name }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ equipment.updated_at|date:"M d, Y" }}</td>
              <td>
                {% if equipment.updated_by %}
                  {{ equipment.updated_by.first_name }} {{ equipment.updated_by.last_name }}
                {% else %}
                  -
                {% endif %}
              </td>
              
              <!-- Action Buttons -->
              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <a href="{% url 'equipments:edit' equipment.id %}" class="btn btn-outline-warning" title="Edit">
                    <i class="bi bi-pencil-square small"></i>
                  </a>
                  {% if is_admin %}
                  <a href="{% url 'equipments:delete' equipment.id %}" class="btn btn-outline-danger" title="Delete" onclick="return confirm('Are you sure?');">
                    <i class="bi bi-trash small"></i>
                  </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>
</div>

<!-- Compact Table Style -->
<style>
.compact-table th,
.compact-table td {
  padding: 0.25rem 0.4rem !important;
  vertical-align: middle;
  font-size: 0.8rem;
}
</style>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
  $(document).ready(function () {
    const table = $('#equipmentTable').DataTable({
      paging: true,
      ordering: true,
      info: true,
      lengthChange: false,
      searching: true,
      dom: 'lrtip'
    });

    $('#tableSearch').on('keyup', function () {
      table.search(this.value).draw();
    });
  });
</script>
{% endblock %}
